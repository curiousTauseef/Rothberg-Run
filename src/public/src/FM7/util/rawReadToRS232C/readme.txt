FM-7シリーズ Disk Raw Read -> RS232C ユーティリティ



[はじめに]
このプログラムを使うとRS232Cポートが使えるFM-7シリーズ実機でディスクを読みだして実機に転送できる。Apolloさん作のD77IMG(http://retropc.net/apollo/)と似ているが違うのはこのプログラムは単体で動作するので実機とRS232CとPCがあれば使える。

なぜか手元にFM77/77AV用3.5インチの棋太平が残っていた。また実家の物置を捜索した結果Music WorldなどいくつかのFM77AV用ソフトを発掘することができた。手元のFM77AVを使うと無事起動する。せっかく見つけたディスクだからイメージ化して保存しておきたいものの、ディスクイメージ化ツールのDITTでは一部セクタが見えないようだった。

エミュレータ用のディスクイメージ化にはいくつか問題がある。ひとつは、ディスクイメージデータ形式がコピープロテクトを完全に再現できない点。生データ形式(.BIN, .XDF)形式だとすべてのトラックが同じセクタ個数で同じセクタ長であることを前提にしている。途中のトラックにひょっこり変なセクタやわざとエラーを入れたようなものは再現できない。FM7エミュレータXM7で使われている.D77形式はある程度エラーや異なるセクタ長を再現できるがタイミングなどが完全ではない。またエミュレータ内でエラーの扱いも実機と完全に一致しない。またPC上でディスクイメージ化するプログラムDITTはコピープロテクトがかかっているトラックの読み込みに頻繁に失敗する。ついでにDITTが実行できる環境がどんどん減っている。

いや現実を直視すると別にソフトをエミュレータで実行したいだけなら著作権的にどうかと思うファイルを簡単に見つけることができる。だけどそういうのは結構データが破損していたり、最悪クリアまで進めなかったり、あるいはコピープロテクトが外れてなかったりする。また、ソフトによってはバージョンがいくつかあるものもあって手元に残っているディスクと出回ってるイメージが微妙に違う場合もある。ついでに言うとディスクイメージはコピープロテクトまで完全に再現できてるわけではない。

コンピュータプログラムは工業製品であると同時に芸術品としての価値もある。とくにコンピュータのパフォーマンスが低い時代にありえないパフォーマンスを引き出したプログラミングは芸術の域に達している。当時のプログラマーは製品を販売して生計を立てなくてはならないが自身の作品を多くのユーザに使ってほしいという葛藤を持っていたと思う。

コピープロテクトは多分そんな葛藤の産物だった。中にはちょっとした手間で簡単に解除できるコピープロテクトがあるかと思えば鬼のように解除が難しいプロテクトもあった。中には解除しようとしたら1バイトを書き換えるであろうということを見越してその1バイトをピンポイントに修復するように作ってあって、まるでコピーを解除しようとする人に挑戦しているかのようなものもあった。コピープロテクト自体が貴重な当時の技術の記録と言っていい。

コピープロテクトを含めてディスクをイメージ化して保存するにはKryoFluxのようなデバイスもある。が、僕はKryoFlux持ってない。しかし、手元に完全に動作するFM77AV40がある。これを使ってKryoFluxに近いものが作れないかと思って作ったのがこのプログラム。

このプログラムは2本のセットで動作する。ひとつはFM77AV40以降、あるいはFM77AV以前でRS232Cカードを搭載している実機で動作するプログラム"RAWREAD","RAWREADM"。もうひとつはRS232C (COM)経由で受信したデータをD77形式ファイルに変換するrawReadToD77。それとRS232Cからデータを受信するためにターミナルソフトが必要。とりあえず実験環境ではTeraTeramを使った。






[Credit]
なお、RS232C出力ルーチンを書くために、Apolloさん製作のD77IMGを参考にさせていただきました。これが無かったらCOMポートの初期化の方法などまったく資料が無い状態で実現不可能だったと思います。貴重なソフトウェアを公開していただいたことに感謝しています。

また、ほとんどWindows上でアセンブルしたものをFM-7エミュレータXM7上でテストすることで開発しました。また、不明な点などはXM7のソースコードも参考にさせていただきました。XM7開発に携わった開発者の皆さんに感謝しています。





[FM-7/77側の設定]
FM77AV40以降であればRS232Cの設定はソフトウェアから実行できるから不要。それより前のモデル (FM77AVとかFM-7とか)だとRS232Cカードのディップスイッチでボーレートなどを設定する必要がある。





[PC側の設定]
ターミナルソフトで(実験ではTera Termを使用)COMポートの設定をFM-7/77側と合わせる必要がある。FM77AV40以降の機種でこのプログラムを実行する場合、このプログラムは自動的に以下のようにCOMポートを設定するのでPC側でも同じ設定にする。

	19200bps
	1 Stop bit
	No parity
	8-bit

なお、FM77AV40で実験したところ、Windows側でFlow制御をHardwareにしないと受信ができない模様。一方的にディスクリードを送信するだけなら問題なし。





[接続]
FM-7/77側は昔懐かしいワイド25ピンのRS232Cコネクタだから、25ピンRS232CからシリアルのクロスケーブルでPC側のCOMポートに接続する。例えば、25ピン→9ピンの変換アダプタ＋クロスアダプタ(Null Modemアダプタ)＋9ピンストレートケーブルとか。ときどき、25ピン→9ピンでしかもクロスさせるアダプタもあるようだ。





[接続テスト]
FM-7/77本体で、

RUN "COMTEST"

としてCOMTESTプログラムを起動する。うまくつながっていると、PC側のターミナルに"Hello from FM-7!"と出るはず。そして、FM-7/77側でスペースキーを押してPCのターミナルに"PING!"というメッセージが出れば成功。





[送信]
まず、PC側のターミナルソフトでログを開始する。

WAVオーディオから実行している場合は最初まで巻き戻して、FM-7/77側で、

RUN "RAWREAD"

ドライブの選択、タイトル(あとで何のディスクだったか識別するために入力することを推奨。何も入れなくても問題は無い)を入力、そして、読み込みたいディスクを指定したドライブに入れてキーを押すと転送開始。

転送が終わるとドライブを聞いてくる。続けて次のディスクを転送したい場合はそのまま続けて転送できる。

全部終わったら、PC側のターミナルソフトでログを保存。





[続き]
ログが取れたら、今度はそれをD77ファイルにしてXM7上で実行できるようにしたいところで、それは別ソフトRawReadToD77(予定)で。
