FM-7/77シリーズテープ版ソフトをRS232C経由で読み込むユーティリティ
by CaptainYS
http://www.ysflight.com/FM/j.html




;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

使い方

F-BASIC起動直後に、次のプログラムを入力。

10 OPEN "I",#1,"COM0:(F8N1)"
20 FOR I=0 TO 255
30 INPUT #1,A%:POKE &H6000+I,A%
40 NEXT
50 CLOSE

F-BASIC起動直後に実行すること。他のプログラムを使った後だと動作しない鴨
しれない。本来であれば CLEAR ,&H5FFF とするべきところだが、次にロードす
るプログラムがマシン語を直接読むタイプで&H6000付近を上書きするような場合
だとしくじるので、ここはあえてCLEARしない。

入力したら、

RUN

として、FM-7/77が待ちに入ったところで、サーバー側でコマンド

IA

を入力すると、&H6000～&H60FFにインストーラが転送される。続いてFM-7/77側で

EXEC &H6000

とするとBIOSフックがインストールされる。続けて、

RUN"

あるいは、マシン語を直接読むタイプだったら、

LOADM"",,R

でプログラム起動。




アンインストール
次のリストを入力して EXEC &H6000

6000  FCFBFA                                          LDD             $FBFA
6003  FD00DF                                          STD             $DF
6006  39                                              RTS





バグ:
なぜかFM77AV40で、プログラム実行後、リセットして再度フックをインストールし
てもうまく動作しない場合がある模様。症状としては、インストーラを転送するま
で動くからRS232Cは動作しているのだが、何もデータが届かない。ついでに、デー
タが届かない場合はサイズ削減のためエラーチェックもタイムアウトチェックもし
ていないためRS232C_READの中で無限ループになるはずなのに普通にBreakキーで止
まる。まるでフックが効いていないかのようにふるまうのだが、モーター音を確認
したくてもオフィスのエアコンがあまりにもうるさくてフックが本当に機能してい
るのか確認できなかった。

電源をいったん斬って再度起動すると普通に動くのだが。

素のFM-7の場合はこの現象は起こらない模様。FM77AV40以降はソフトウェア的に
RS232Cのオン・オフができるので、何かそれと関係があるのかもしれない。




;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Emergency (COMPAC)
実機FM77AV40とFM-7で確認。ゲーム開始、ターゲット1個破壊まで確認。
デフォルトインストールアドレス、ブリッジアドレスのままで動作。



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Dragon Slayer (FALCOM)
実機FM77AV40で確認。デモ・ゲーム開始まで。3回連続成功したから多分大丈夫。
デフォルトインストールアドレス、ブリッジアドレスのままで動作。



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

Delphis (COMPAC)
実機FM77AV40とFM-7で確認。ゲーム開始、キーで自機を操作するところまで確認。
デフォルトインストールアドレス、ブリッジアドレスのままで動作。

ただし、次のF-BASICプログラムで起動する必要あり。

10 CLEAR ,&H14FF
20 LOADM"DATA"
30 POKE &H68B1,&HFD
40 POKE &H68B2,&H05
50 POKE &H68B3,&H2A
60 POKE &H68B4,&HFB
70 EXEC
80 LOADM"DELPH.M"
90 POKE &H560D,&HFD
100 POKE &H560E,&H05
110 POKE &H560F,&H2A
120 POKE &H5610,&HFB
130 EXEC

最初AV40で単純に RUN "" で実行しようとしたら3～5回に1回ぐらいしか起動に成功
しないので逆アセンブルを見たらサブCPUがかなりシビアなタイミングでHALT要求に
応答することを前提に書いてあった。

LDA #$80, STA$FD05して次のクロックでサブCPUがHALTしてるなどということがあり
得るのだろうか？

FM77AV40特有の問題かと思って素のFM-7でも試したけど結果は同じ。上のローダー
なら起動するけどデフォルトで入ってるローダーでは滅多に起動しない。当時よく
これで本当に動いていたんだろうか？I/OにDebug出てたっけ？

本当は少なくとももう一か所(サブCPUにプログラムを転送するところ)あるのだが、
直せない。が、どうやらこの二か所を直しておけば、5回連続起動できたから大丈夫
のようだ。


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

PLAZMA LINE (TECHNO SOFT)
実機FM77AV40とFM-7  で確認。ゲーム開始、キーで自機を操作するところまで確認。
デフォルトインストールアドレス、ブリッジアドレスのままで動作。



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

DIG DUG (NAMCO,電波新聞社)
実機FM77AV40とFM-7で確認。

2本目のLOADM後、MOTOR OFFになるが3本目のLOADMでMOTOR ONのBIOSコールが発生
しない問題が発生したので、フック先CTBRED、CTBWRTで#$B7を$FD07に書き込むよ
うに修正したら動いた。


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

テラ4001 (T&E)
実機FM77AV40で確認。
t77Serverに追加オプションが必要 -install 7f80 -bridge 7f80
オープニングデモ～開始まで確認。セーブもできたっぽい。


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

FM-7デモ (富士通)
実機FM77AV40で確認。


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

FM-new7デモ (富士通)
実機FM77AV40で確認。


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

EES成績処理教育評定専用プログラム (URBAN SOFT)
実機FM77AV40で確認。起動するとこまで。オールBASICだから絶対成功すると思っ
たんだ。実家にあったんだけど超絶レアものだと思う。
